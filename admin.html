<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ادارة المستشفى</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0712; --panel:#0f0b1a; --card:#131020; --muted:#a7a4be; --text:#efecff;
  --brand:#8b7bff; --accent:#ff6b9e; --ok:#54e6a6; --border:1px solid rgba(255,255,255,.08);
  --cyan:#7fd8ff;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 500px at 20% -10%, rgba(139,123,255,.11), transparent), var(--bg); color:var(--text); font-family:"Cairo",sans-serif}
.container{width:min(1200px,92%);margin:auto}

/* Intro */
#intro{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0613 0%,#120c1f 70%);}
.intro-box{display:grid;place-items:center;gap:8px;text-align:center;animation:fadeUp .7s ease both}
.intro-logo{width:110px;height:110px;border-radius:28px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 10px 40px rgba(139,123,255,.35);animation:pulse 1.8s ease-in-out infinite}
.intro-title{font-size:22px;font-weight:800}
.intro-sub{font-size:13px;color:#c8c3e7}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.hide-intro{animation:fadeOut .8s ease forwards}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

/* NAV */
nav{position:sticky;top:0;z-index:30;background:rgba(15,11,26,.7);backdrop-filter:blur(10px);border-bottom:var(--border)}
.nav-in{display:flex;align-items:center;gap:12px;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand .logo{width:34px;height:34px;border-radius:10px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 0 0 1px rgba(255,255,255,.09) inset}
.search{flex:1;display:flex;align-items:center;background:#17132c;border:var(--border);border-radius:12px;padding:8px 12px}
.search input{all:unset;flex:1;color:var(--text);}
.actions{display:flex;gap:8px;margin-inline-start:auto}
.btn{padding:10px 12px;border-radius:12px;border:var(--border);background:#1a1531;color:var(--text);font-weight:700;cursor:pointer}
.btn.primary{background:#211a48}
.btn.danger{background:#361b2a}
.btn.ghost{background:#171230}

/* chip link */
.link-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171230;color:#e9e9ff;text-decoration:none;font-weight:700;font-size:12px}
.link-chip .ico{font-size:14px;opacity:.85}

/* stat */
.stat{display:inline-flex;align-items:center;gap:10px;cursor:pointer;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171230;color:#dfe3ff;font-weight:700;font-size:12px}
.stat .dot{width:8px;height:8px;border-radius:50%;background:#3be48f;box-shadow:0 0 0 3px rgba(59,228,143,.12)}
.stat small{opacity:.8;font-weight:600}

/* زر الفلترة بصورة */
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;border:var(--border);background:#171230;cursor:pointer}
.icon-btn img{width:22px;height:22px;filter:invert(1)}

/* فلتر مطابق للـindex */
.filter-wrap{position:relative}
.filter-panel{position:absolute;right:0;top:42px;width:260px;background:#0f0b1a;border:var(--border);border-radius:14px;padding:10px;display:none;z-index:40}
.filter-panel.open{display:block}
.filter-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
.filter-panel label{
  font-size:13px;color:#d6dcf3;font-weight:500;
  display:flex;flex-direction:row-reverse;align-items:center;gap:8px;
}
.filter-row .count{font-size:12px;color:#9fb0c4;background:#15122a;border:1px solid rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;min-width:28px;text-align:center}
.filter-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* GRID */
.org{display:grid;gap:18px;margin:16px 0}
.row{display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
.row-A{justify-content:center;margin-top:6px}
.row-A .card{transform:translateY(-8px)}
.row-V{justify-content:center}

/* CARD */
.card{position:relative;background:rgba(25,18,38,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;width:260px;box-shadow:0 8px 28px rgba(139,92,246,.10)}
.card .media{display:grid;place-items:center;padding:14px 0 6px}
.card .avatar{width:88px;height:88px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.1);box-shadow:0 0 0 4px rgba(255,255,255,.05)}
.card .content{padding:10px 12px;display:grid;gap:6px}
.card .title{font-size:15px;font-weight:800}
.card .meta{font-size:12px;color:#aeb6c7;display:grid;gap:2px}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:11px;line-height:1;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#cfd6e6}
.pill.heli{border-color:#ff6b6b;color:#ff9aa2;background:rgba(255,107,107,.12)}
.rank-badge{position:absolute;inset:8px 8px auto auto;background:#281f4e;border:1px solid rgba(255,255,255,.12);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}

/* badges */
.health-badge{position:absolute;inset:8px auto auto 8px;background:rgba(127,216,255,.14);color:#bfeaff;border:1px solid rgba(127,216,255,.35);padding:4px 8px;border-radius:999px;font-size:12px}

/* warns */
.warns{position:absolute;bottom:12px;left:12px;display:flex;gap:6px}
.warns .w{width:8px;height:8px;border-radius:50%;background:#3a3a50;border:1px solid rgba(255,255,255,.12)}
.warns .w.active{background:#ff9aa9}

/* dialog & form */
dialog{border:none;border-radius:16px;background:#120d1f;color:var(--text);width:min(720px,94%);max-height:90vh;padding:16px}
fieldset{border:var(--border);border-radius:14px;padding:14px;margin:8px 0 14px}
legend{color:var(--muted);font-size:13px;padding:0 6px}
.preview{display:flex;gap:12px;align-items:center;border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:10px;background:#141129}
#photoPreview{width:84px;height:84px;object-fit:cover;border-radius:50%;border:var(--border)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{font-size:13px;font-weight:700;display:block;margin-bottom:6px}
input,select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:var(--border);background:#15122a;color:var(--text)}
textarea{min-height:90px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 16px}
.check{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#141129;border:1px solid rgba(255,255,255,.10);border-radius:12px;font-size:13px;color:#cfd4ea}
.check input[type="checkbox"]{width:16px;height:16px}
.warn-select{display:flex;gap:8px;align-items:center}
.warn-select .warn-dot{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;background:#1a1531;border:var(--border);color:#cfd4ea;cursor:pointer;user-select:none;font-weight:700;font-size:12px}
.warn-select .warn-dot.active{background:#2c1f55;box-shadow:0 0 0 1px rgba(139,123,255,.25) inset}
dialog .btn{padding:8px 12px;border-radius:10px;font-size:12px}

/* Mobile */
@media (max-width: 520px){
  .card{width:220px}
  .warns .w{width:6px;height:6px}
  .rank-badge,.health-badge{font-size:11px;padding:3px 8px}
  .pill{font-size:10px;padding:5px 8px}
}
.btn{
  background:#1a1531 !important;
  color:var(--text) !important;
  border:1px solid rgba(255,255,255,.12) !important;
  border-radius:12px;
  padding:10px 12px;
  font-weight:700;
  cursor:pointer;
  transition:.15s ease;
}
.btn.primary{ background:#211a48 !important; }
.btn.danger{  background:#361b2a !important; }
.btn.ghost{   background:#171230 !important; }
.btn:hover{ transform:translateY(-1px); }
.btn:active{ transform:translateY(0); }

.actions .btn{ box-shadow:0 6px 16px rgba(139,123,255,.12); }
.card .btn{ background:#1a1531 !important; }
.card .btn.danger{ background:#361b2a !important; }
dialog .btn{ background:#1a1531 !important; }
dialog .btn.primary{ background:#211a48 !important; }

.filter-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
.filter-panel label{display:flex;flex-direction: row;align-items:center;gap:8px;font-size:13px;color:#d6dcf3;font-weight:500}
.filter-panel label input{order:-1}
.filter-row .count{font-size:12px;color:#9fb0c4;background:#15122a;border:1px solid rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;min-width:28px;text-align:center}
</style>
</head>
<body>

<div id="intro"><div class="intro-box">
  <div class="intro-logo"></div>
  <div class="intro-title">مستشفى ريسبكت</div>
  <div class="intro-sub">ادارة الطاقم</div>
</div></div>

<nav>
  <div class="container nav-in">
    <div class="brand"><span class="logo"></span><span>ادارة المستشفى</span></div>
    <div class="search"><input id="searchInput" placeholder="بحث بالاسم او الرقم الوطني"></div>

    <div class="stat" id="statTotal" title="تحديث"><span class="dot"></span><span>الاجمالي</span><small>0</small></div>

    <div class="actions">
      <button id="addBtn" class="btn primary">اضافة</button>
      <button id="reindexBtn" class="btn">تحديث الاكواد</button>
      <a class="link-chip" href="promotion.html"><span class="ico">⬈</span><span>متطلبات الترقية</span></a>
<a href="logs-hospital.html" class="btn">logs</a>

      <div class="filter-wrap">
        <button id="openFilters" class="icon-btn" aria-label="فلترة">
          <img src="setting.png" alt="فلترة">
        </button>

        <div class="filter-panel" id="filterPanel">
          <div class="filter-row"><label><input type="checkbox" data-r="A"> مسؤول</label><span class="count" id="cntA">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="V"> نائب</label><span class="count" id="cntV">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="AD"> استشاري</label><span class="count" id="cntAD">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="DS"> أخصائي</label><span class="count" id="cntDS">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="D"> دكتور</label><span class="count" id="cntD">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="DA">د.مساعد</label><span class="count" id="cntDA">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="N"> ممرض</label><span class="count" id="cntN">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="T"> متدرب</label><span class="count" id="cntT">0</span></div>
          <div class="filter-row"><label><input type="checkbox" data-r="C"> متطوع</label><span class="count" id="cntC">0</span></div>

          <div class="filter-actions">
            <button id="applyFilters" class="link-chip" type="button"><span class="ico">✓</span>تطبيق</button>
            <button id="resetFilters" class="link-chip" type="button"><span class="ico">↺</span>مسح</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<header class="container"></header>

<main class="container">
  <div id="org" class="org"></div>
</main>

<dialog id="formDialog">
  <form id="personForm">
    <h3 style="margin:0 0 8px">بيانات الموظف</h3>

    <div class="preview" id="dropZone" title="اسحب/ألصق صورة">
      <img id="photoPreview" alt="صورة"/>
      <div style="flex:1">
        <label>الصورة</label>
        <input type="file" id="photo" accept="image/*" />
        <div style="font-size:12px;color:var(--muted);margin-top:6px">اضافةاو لصق للصورة</div>
      </div>
    </div>

    <div class="row2">
      <div><label>الاسم</label><input id="name" required></div>
      <div><label>الرقم الوطني</label><input id="nid" required></div>
    </div>

    <div class="row2">
      <div>
        <label>الرتبة</label>
        <select id="rank" required>
          <option value="A">مسؤول</option><option value="V">نائب</option><option value="AD">استشاري</option>
          <option value="DS">أخصائي</option><option value="D">دكتور</option><option value="DA">مساعد دكتور</option>
          <option value="N">ممرض</option><option value="T">متدرب</option><option value="C">متطوع</option>
        </select>
      </div>
      <div><label>رقم التسلسل داخل الرتبة</label><input id="rankNo" type="number" min="1" value="1" required></div>
    </div>

    <div class="row2">
      <div>
        <label>الدور الصحي</label>
        <select id="healthRole">
          <option value="">— لا يوجد —</option>
          <option value="مشرف الصحة">مشرف الصحة</option>
          <option value="مدرب الصحة">مدرب الصحة</option>
        </select>
      </div>
      <div>
        <label>التخصص</label>
        <select id="specialty">
          <option value="">— بدون —</option>
          <option>عيون</option>
          <option>جراحة عامة</option>
          <option>عظام</option>
          <option>قلب</option>
          <option>مخ وأعصاب</option>
          <option>أنف وأذن وحنجرة</option>
          <option>جلدية</option>
          <option>طوارئ</option>
          <option>تخدير</option>
          <option>أشعة</option>
          <option>مختبر</option>
          <option>علاج طبيعي</option>
          <option>تأهيل</option>
          <option>علم نفس</option>
        </select>
      </div>
    </div>

    <fieldset>
      <legend>الشهادات / الاختبارات</legend>
      <div class="form-grid">
        <label class="check"><input type="checkbox" id="cert_heli"><span>شهادة هيلكوبتر</span></label>
        <label class="check"><input type="checkbox" id="cert_ops"><span>شهادة عمليات</span></label>
        <label class="check"><input type="checkbox" id="cert_diving"><span>شهادة غوص</span></label>
        <label class="check"><input type="checkbox" id="cert_boat"><span>شهادة قيادة قارب</span></label>
        <label class="check"><input type="checkbox" id="cert_fitness"><span>تقرير فحص لياقة</span></label>
        <label class="check"><input type="checkbox" id="cert_med_report"><span>تقارير طبية</span></label>
        <label class="check"><input type="checkbox" id="test_specialty"><span>اختبار بالتخصص</span></label>
        <label class="check"><input type="checkbox" id="test_reports"><span>اختبارات تقارير</span></label>
        <label class="check"><input type="checkbox" id="test_mountain"><span>اختبار الجبال</span></label>
         <label class="check"><input type="checkbox" id="test_mountain"><span>اختبار القيادة</span></label>
      </div>
    </fieldset>

    <div>
      <label>الإنذارات (0–3)</label>
      <div class="warn-select" id="warnSelect">
        <div class="warn-dot" data-v="0">0</div><div class="warn-dot" data-v="1">1</div>
        <div class="warn-dot" data-v="2">2</div><div class="warn-dot" data-v="3">3</div>
      </div>
    </div>

    <div><label>ملاحظات</label><textarea id="notes" rows="3"></textarea></div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button type="button" class="btn" id="cancelBtn">إلغاء</button>
      <button type="submit" class="btn primary">حفظ</button>
    </div>
    <input type="hidden" id="editId">
  </form>
</dialog>

<footer style="text-align:center;padding:18px 0;color:var(--muted);border-top:var(--border);background:#0f0b1a">
  © <span id="year"></span> مستشفى ريسبكت
</footer>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://kdsnmgfrdykmupnrmksy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkc25tZ2ZyZHlrbXVwbnJta3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE2NDgsImV4cCI6MjA3NDcyNzY0OH0.Ly_frv4P1P45OYmTEt6hDThSx5rD6S1a96dNKhVc1Yc";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET = "photos";



const org = document.getElementById('org');
const statTotal = document.getElementById('statTotal');
const searchInput = document.getElementById('searchInput');
const openFilters = document.getElementById('openFilters');
const filterPanel = document.getElementById('filterPanel');
const applyFilters = document.getElementById('applyFilters');
const resetFilters = document.getElementById('resetFilters');
const formDialog = document.getElementById('formDialog');
document.getElementById('year').textContent = new Date().getFullYear();

(async ()=>{
  const { data: { user } } = await sb.auth.getUser();
  if (!user) {
    const email = prompt('الإيميل الإداري:');
    const pwd   = prompt('كلمة المرور:');
    if (!email || !pwd) { location.replace('index.html'); return; }

    const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
    if (error) {
      alert('فشل تسجيل الدخول: ' + (error.message || 'تحقق من الإيميل/كلمة المرور أو تأكيد البريد'));
      location.replace('index.html');
      return;
    }
  }
})();


setTimeout(()=>document.getElementById('intro')?.classList.add('hide-intro'),1200);

const rankOrder = ['A','V','AD','DS','D','DA','N','T','C'];
const rankLabel = r => ({A:'مسؤول',V:'نائب',AD:'استشاري',DS:'أخصائي',D:'دكتور',DA:'مساعد دكتور',N:'ممرض',T:'متدرب',C:'متطوع'})[r]||r;

const q = s=>document.querySelector(s);
const form = q('#personForm'), editId=q('#editId');
const nameInput=q('#name'), nidInput=q('#nid'), rankSelect=q('#rank'), rankNoInput=q('#rankNo');
const photoInput=q('#photo'), photoPreview=q('#photoPreview'), dropZone=q('#dropZone');
const healthRole=q('#healthRole'), specialty=q('#specialty');

const cert_heli=q('#cert_heli'), cert_ops=q('#cert_ops'), cert_diving=q('#cert_diving'), cert_boat=q('#cert_boat');
const cert_med_report=q('#cert_med_report'), cert_fitness=q('#cert_fitness'), test_specialty=q('#test_specialty'), test_reports=q('#test_reports'), test_mountain=q('#test_mountain');

const warnSelect=q('#warnSelect'); let currentWarnings=0;
q('#cancelBtn').onclick=()=>formDialog.close();

let ALL=[];
let STATE={ ranks:new Set(), q:'' };

warnSelect.querySelectorAll('.warn-dot').forEach(d=>{
  d.onclick=()=>{
    currentWarnings=parseInt(d.dataset.v,10);
    warnSelect.querySelectorAll('.warn-dot').forEach(x=>x.classList.remove('active'));
    for(let i=0;i<=currentWarnings;i++) warnSelect.querySelector(`[data-v="${i}"]`)?.classList.add('active');
  };
});

const pill = (t, cls='')=>`<span class="pill ${cls}">${t}</span>`;
const certList = x=>{
  const a=[];
  if(x.cert_heli) a.push({t:'شهادة هيلكوبتر', cls:'heli'});
  if(x.cert_ops) a.push({t:'شهادة عمليات'});
  if(x.cert_diving) a.push({t:'شهادة غوص'});
  if(x.cert_boat) a.push({t:'شهادة قيادة قارب'});
  if(x.cert_fitness) a.push({t:'تقرير فحص لياقة'});
  if(x.cert_med_report) a.push({t:'تقارير طبية'});
  if(x.test_specialty) a.push({t:'اختبار بالتخصص'});
  if(x.test_reports) a.push({t:'اختبارات تقارير'});
  if(x.test_mountain) a.push({t:'اختبار الجبال'});
  return a;
};
const warnsHTML = n=> new Array(3).fill(0).map((_,i)=>`<span class="w ${n>i?'active':''}"></span>`).join('');

window.__edit=id=>window.openForm(ALL.find(x=>x.id===id));
window.__del=async id=>{
  if(!confirm('تأكيد الحذف؟')) return;
  const rec = ALL.find(r=>r.id===id);
  await sb.from('staff').delete().eq('id',id);
  await reorderRank(rec.rank);
  await load();
};

function cardHTML(x){
  const certs = certList(x).map(c=>pill(c.t, c.cls||'')).join('');
  const health = x.health_role ? `<div class="health-badge">${x.health_role}</div>` : '';
  return `
  <article class="card">
    <div class="rank-badge">${x.rank}-${x.rank_no}</div>
    ${health}
    <div class="media"><img class="avatar" src="${x.photo||''}" alt="${x.name||''}"></div>
    <div class="content">
      <div class="title">${x.name||'بدون اسم'}</div>
      <div class="meta">
        <div>الرقم الوطني: <b>${x.nid||'—'}</b></div>
        <div>الرتبة: <b>${rankLabel(x.rank)}</b></div>
        ${x.specialty ? `<div>التخصص: <b>${x.specialty}</b></div>`:''}
      </div>
      <div class="pills">${certs}</div>
    </div>
    <div class="card-actions" style="display:flex;gap:8px;padding:8px 12px;border-top:1px solid rgba(255,255,255,.06);background:#0f0b1a">
      <button class="btn" onclick="window.__edit('${x.id}')">تعديل</button>
      <button class="btn danger" onclick="window.__del('${x.id}')">حذف</button>
    </div>
    <div class="warns">${warnsHTML(x.warnings||0)}</div>
  </article>`;
}

function render(){
  const qtxt=STATE.q.trim().toLowerCase();
  let list=ALL.filter(x=>{
    const okRank = STATE.ranks.size ? STATE.ranks.has(x.rank) : true;
    const okQ = !qtxt || x.name?.toLowerCase().includes(qtxt) || x.nid?.includes(qtxt);
    return okRank && okQ;
  });

  const groups = {}; rankOrder.forEach(r=>groups[r]=[]);
  list.forEach(x=>groups[x.rank]?.push(x));
  rankOrder.forEach(r=>groups[r].sort((a,b)=>(a.rank_no||0)-(b.rank_no||0)));

  org.innerHTML = `
    <div class="row row-A">${groups.A.map(cardHTML).join('')}</div>
    <div class="row row-V">${groups.V.map(cardHTML).join('')}</div>
    ${['AD','DS','D','DA','N','T','C'].map(r=>`
      <div class="row row-${r}">${groups[r].map(cardHTML).join('')}</div>`).join('')}
  `;

  statTotal.querySelector('small').textContent = `${list.length}`;

  const counts = countByRank(ALL);
  for(const r of rankOrder){
    const el = document.getElementById('cnt'+r) || document.getElementById('cnt'+(r==='AD'?'AD':r));
    if(el) el.textContent = counts[r]||0;
  }
}

function countByRank(data){
  const out={}; for(const r of rankOrder) out[r]=0;
  data.forEach(x=>{ if(out[x.rank]!==undefined) out[x.rank]++; });
  return out;
}

async function load(){
  const {data,error}=await sb.from('staff').select('*');
  ALL = error?[]:data||[];
  render();
}
statTotal.onclick=load;

searchInput.oninput=()=>{STATE.q=searchInput.value;render();};

openFilters.onclick=(e)=>{ e.stopPropagation(); filterPanel.classList.toggle('open'); };

applyFilters.onclick=()=>{
  const checks = filterPanel.querySelectorAll('input[type="checkbox"][data-r]');
  const selected = Array.from(checks).filter(c=>c.checked).map(c=>c.getAttribute('data-r'));
  STATE.ranks = new Set(selected);
  render();
};

resetFilters.onclick=()=>{
  const checks = filterPanel.querySelectorAll('input[type="checkbox"][data-r]');
  checks.forEach(c=>c.checked=false);
  STATE.ranks = new Set();
  render();
};

document.addEventListener('click', (e)=>{
  const withinPanel = filterPanel.contains(e.target);
  const onButton = openFilters.contains(e.target);
  if(filterPanel.classList.contains('open') && !withinPanel && !onButton){
    filterPanel.classList.remove('open');
  }
});

window.openForm = function(item){
  form.reset(); photoPreview.src=''; editId.value=''; currentWarnings=0;
  warnSelect.querySelectorAll('.warn-dot').forEach(x=>x.classList.remove('active'));

  if(item){
    editId.value=item.id; nameInput.value=item.name||''; nidInput.value=item.nid||'';
    rankSelect.value=item.rank||'A'; rankNoInput.value=item.rank_no||1; photoPreview.src=item.photo||'';
    healthRole.value=item.health_role||''; specialty.value=item.specialty||'';
    cert_heli.checked=!!item.cert_heli; cert_ops.checked=!!item.cert_ops; cert_diving.checked=!!item.cert_diving; cert_boat.checked=!!item.cert_boat;
    cert_med_report.checked=!!item.cert_med_report; cert_fitness.checked=!!item.cert_fitness; test_specialty.checked=!!item.test_specialty; test_reports.checked=!!item.test_reports; test_mountain.checked=!!item.test_mountain;
    currentWarnings=item.warnings||0; for(let i=0;i<=currentWarnings;i++) warnSelect.querySelector(`[data-v="${i}"]`)?.classList.add('active');
    (q('#notes')).value=item.notes||'';
  }
  formDialog.showModal();
};
document.getElementById('addBtn').onclick=()=>window.openForm();

document.addEventListener("paste",e=>{
  if(!formDialog.open) return;
  const it=e.clipboardData?.items||[];
  for(const t of it){
    if(t.type.startsWith('image/')){
      const f=t.getAsFile(); if(f) handleFile(f);
      e.preventDefault(); break;
    }
  }
});
['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.add('drag');}));
['dragleave','drop'].forEach(ev=> dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.remove('drag');}));
dropZone.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
photoInput.onchange=()=>{ const f=photoInput.files?.[0]; if(f) handleFile(f); };
function handleFile(file){ const fr=new FileReader(); fr.onload=()=>{photoPreview.src=fr.result}; fr.readAsDataURL(file); }
const fileToDataUrl=f=>new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(f);});

/* ====== رفع الصور تلقائياً إلى التخزين ثم حفظ السجل ====== */
function dataUrlToBlob(d){
  const [h,b]=String(d).split(',');
  const mime=(h?.split(';')[0]||'').replace('data:','')||'image/png';
  const bin=atob(b||'');
  const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8],{type:mime});
}
function extFromType(t){ return t==='image/jpeg'?'jpg':t==='image/png'?'png':t==='image/webp'?'webp':'bin'; }
function uniquePhotoPath(id, type){
  const ext = extFromType(type||'image/png');
  const nonce = Date.now()+'-'+Math.random().toString(36).slice(2,7);
  return `staff/${id}/${nonce}.${ext}`;
}

form.onsubmit=async e=>{
  e.preventDefault();

  const isEdit = !!editId.value;
  const id = isEdit ? editId.value : crypto.randomUUID();
  const existing = isEdit ? ALL.find(r=>r.id===id) : null;
  const oldRank = existing?.rank;

  let fileOrBlob=null;
  if(photoInput.files?.[0]) fileOrBlob = photoInput.files[0];
  else if(photoPreview.src && photoPreview.src.startsWith('data:')) fileOrBlob = dataUrlToBlob(photoPreview.src);

  let photoUrl = existing?.photo || null;

  if(fileOrBlob){
    const path = uniquePhotoPath(id, fileOrBlob.type);
    const up = await sb.storage.from(BUCKET).upload(path, fileOrBlob, {
      upsert:false,
      contentType:fileOrBlob.type || 'image/png',
      cacheControl:'31536000'
    });
    if(up.error){ alert('فشل رفع الصورة: '+up.error.message); return; }
    const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
    photoUrl = data.publicUrl;
  }

 const obj = {
  id,
  name: nameInput.value.trim(),
  nid: nidInput.value.trim(),
  rank: rankSelect.value,
  rank_no: parseInt(rankNoInput.value, 10) || 1,
  photo: photoUrl || null,
  health_role: healthRole.value || '',
  specialty: specialty.value || '',
  cert_heli: !!cert_heli.checked,
  cert_ops: !!cert_ops.checked,
  cert_diving: !!cert_diving.checked,
  cert_boat: !!cert_boat.checked,
  cert_fitness: !!cert_fitness.checked,
  cert_med_report: !!cert_med_report.checked,
  test_specialty: !!test_specialty.checked,
  test_reports: !!test_reports.checked,
  test_mountain: !!test_mountain.checked,
  warnings: currentWarnings,
  notes: (q('#notes')?.value || '').trim()
};

const { error } = await sb.from('staff').upsert(obj);
if (error) { alert('فشل الحفظ: ' + error.message); return; }

formDialog.close();
await load();
    reorderRank(obj.rank),
    oldRank && oldRank!==obj.rank ? reorderRank(oldRank) : Promise.resolve()
  ;

  formDialog.close();
  await load();
};

async function reorderRank(rankCode){
  const {data,error}=await sb.from('staff').select('id,rank,rank_no').eq('rank',rankCode);
  if(error||!data) return;
  data.sort((a,b)=> (a.rank_no||0)-(b.rank_no||0) || (a.id>b.id?1:-1));
  let i=1;
  for(const rec of data){
    if(rec.rank_no!==i){
      await sb.from('staff').update({rank_no:i}).eq('id',rec.id);
    }
    i++;
  }
}
document.getElementById('reindexBtn').onclick = async ()=>{
  for(const r of rankOrder){ await reorderRank(r); }
  await load();
};

sb.channel('staff-rt').on('postgres_changes',{event:'*',schema:'public',table:'staff'},p=>{
  const {eventType,new:NEW,old:OLD}=p;
  if(eventType==='INSERT'){ALL.push(NEW);}
  else if(eventType==='UPDATE'){const i=ALL.findIndex(r=>r.id===NEW.id); if(i>-1) ALL[i]=NEW; else ALL.push(NEW);}
  else if(eventType==='DELETE'){ALL=ALL.filter(r=>r.id!==OLD.id);}
  render();
}).subscribe();

await load();
</script>
</body>
</html>

