<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوق المستشفى</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#080712; --bg2:#0f0b1f;
  --panel:rgba(17,14,33,.72);
  --card:rgba(18,16,36,.55);
  --text:#F2EFFF; --muted:#bfbad8;
  --chip:#15132a; --chip-br:rgba(255,255,255,.12);
  --ok:#63e7c4; --info:#75c9ff; --warn:#ffd36e; --danger:#ff8fb7;
  --border:1px solid rgba(255,255,255,.10);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--text); font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1000px 600px at 12% -10%, rgba(154,134,255,.15), transparent),
    radial-gradient(900px 600px at 92% 120%, rgba(106,240,194,.10), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}

/* NAV */
nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(16,12,32,.9),rgba(16,12,32,.65));backdrop-filter:blur(14px);border-bottom:var(--border)}
.nav-in{width:min(1100px,92%);margin:auto;padding:10px 0;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand .logo{width:34px;height:34px;border-radius:10px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:center;background:rgba(18,16,36,.45);border:var(--border);border-radius:12px;padding:6px 8px}
.toolbar>*{background:#171230;border:var(--border);color:var(--text);border-radius:10px;padding:8px 10px;font-weight:700;font-size:12px}
.toolbar .refresh{background:linear-gradient(180deg,#2b1e69,#221a51);cursor:pointer;border-color:rgba(154,134,255,.4)}
.link{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:var(--border);background:#171230;color:#e9e9ff;text-decoration:none;font-weight:800;font-size:12px}
.container{width:min(1100px,92%);margin:18px auto 40px}

/* TIMELINE + CARD (Discord-like) */
.timeline{position:relative}
.card{
  position:relative; overflow:hidden; margin:10px 0; padding:12px 14px 10px;
  background:var(--card); border:var(--border); border-radius:14px;
  box-shadow:0 14px 28px rgba(0,0,0,.26);
}
.card::before{ /* شريط جانبي يغيّر لونه حسب العملية */
  content:""; position:absolute; inset:0 auto 0 0; width:4px; background:var(--info);
}
.card[data-op="insert"]::before{ background:var(--ok); }
.card[data-op="update"]::before{ background:var(--info); }
.card[data-op="delete"]::before{ background:var(--danger); }

/* رأس البطاقة */
.head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.op-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--chip-br);background:#151736;font-weight:900;font-size:12px}
.op-chip.insert{background:rgba(99,231,196,.14);border-color:rgba(99,231,196,.28);color:#dffdf6}
.op-chip.update{background:rgba(117,201,255,.14);border-color:rgba(117,201,255,.28);color:#e9f6ff}
.op-chip.delete{background:rgba(255,143,183,.14);border-color:rgba(255,143,183,.28);color:#ffe6ef}
.time{padding:3px 8px;border:1px solid var(--chip-br);background:#15122d;border-radius:8px;font-size:12px;color:#dfe7ff}
.actor{margin-inline-start:auto;display:flex;align-items:center;gap:8px;font-weight:800}
.avatar{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:#1b1533;border:1px solid var(--chip-br);color:#cfe2ff;font-size:11px}
.count{background:#15122a;border:var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:#cdd5ff}

/* هدف العملية (سطر واحد لطيف) */
.target{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 6px}
.badge{background:var(--chip);border:1px solid var(--chip-br);padding:4px 10px;border-radius:999px;font-size:12px;color:#c9c6ee}
.target b{color:#fff}

/* قائمة التغييرات – شكل سطر واحد مثل رسائل الديسكورد */
.diffs{display:grid;gap:6px}
.diffline{
  display:flex;align-items:center;gap:10px;
  background:rgba(17,15,38,.45); border:1px solid var(--chip-br);
  border-radius:10px; padding:8px 10px; font-size:13px;
  /* مهم: نخلي اتجاه السطر LTR عشان السهم يظل يشير من القديم إلى الجديد */
  direction:ltr;
}
.diffline .label{direction:rtl; font-weight:800; color:#e9e6ff; background:var(--chip); border:1px solid var(--chip-br); padding:2px 8px; border-radius:999px}
.diffline .old{direction:rtl; opacity:.8}
.diffline .arrow{opacity:.75}
.diffline .new{direction:rtl; font-weight:800}
.thumb{width:38px;height:38px;border-radius:8px;object-fit:cover;border:1px solid var(--chip-br);vertical-align:middle}

/* رسائل فارغة / خطأ */
.msg{padding:16px;text-align:center;color:var(--muted);border:1px dashed rgba(255,255,255,.25);border-radius:12px;background:rgba(18,16,36,.35)}

/* موبايل */
@media (max-width:640px){
  .nav-in{grid-template-columns:1fr auto}
  .brand{grid-column:1/3}
  .toolbar{flex-wrap:wrap}
}
</style>
</head>
<body>

<nav>
  <div class="nav-in">
    <div class="brand"><span class="logo"></span><span>لوق المستشفى</span></div>

    <div class="toolbar">
      <button id="refresh" class="refresh">تحديث</button>
      <select id="opFilter">
        <option value="all">كل العمليات</option>
        <option value="insert">insert</option>
        <option value="update">update</option>
        <option value="delete">delete</option>
      </select>
      <input id="from" type="date" title="من" />
      <span>إلى</span>
      <input id="to" type="date" title="إلى" />
      <input id="search" placeholder="بحث بالاسم/الإيميل" style="flex:1" />
    </div>

    <div class="nav-actions">
      <a class="link" href="admin.html">⟵ رجوع للإدارة</a>
    </div>
  </div>
</nav>

<main class="container">
  <section class="timeline">
    <div id="logsWrap"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const sb = createClient(
    "https://kdsnmgfrdykmupnrmksy.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkc25tZ2ZyZHlrbXVwbnJta3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE2NDgsImV4cCI6MjA3NDcyNzY0OH0.Ly_frv4P1P45OYmTEt6hDThSx5rD6S1a96dNKhVc1Yc"
  );

  const wrap     = document.getElementById("logsWrap");
  const refresh  = document.getElementById("refresh");
  const opFilter = document.getElementById("opFilter");
  const search   = document.getElementById("search");
  const fromDate = document.getElementById("from");
  const toDate   = document.getElementById("to");

  const toKSA = (ts)=>{
    try{
      return new Date(ts).toLocaleString('en-GB',{
        timeZone:'Asia/Riyadh',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }catch{ return ts; }
  };

  const rankLabel = r => ({A:'مسؤول',V:'نائب',AD:'استشاري',DS:'أخصائي',D:'دكتور',DA:'مساعد دكتور',N:'ممرض',T:'متدرب',C:'متطوع'})[r]||r;
  const labelMap = {
    name:'الاسم', nid:'الرقم الوطني', rank:'الرتبة', rank_no:'التسلسل',
    health_role:'الدور الصحي', specialty:'التخصص', warnings:'الإنذارات',
    photo:'الصورة', notes:'الملاحظات',
    cert_heli:'شهادة هليكوبتر', cert_ops:'شهادة عمليات', cert_diving:'شهادة غوص',
    cert_boat:'شهادة قيادة قارب', cert_fitness:'تقرير فحص لياقة', cert_med_report:'تقارير طبية',
    test_specialty:'اختبار بالتخصص', test_reports:'اختبارات تقارير', test_mountain:'اختبار الجبال'
  };
  const label = k => labelMap[k] || k;

  const isBool = v => v === true || v === false;

  // نعرّف "صورة" حتى لو رابط سوپابيز بلا امتداد
  const looksLikeImage = (v, key) => {
    if (key === 'photo' && typeof v === 'string') return true;
    if (typeof v !== 'string') return false;
    const http = /^https?:\/\//i.test(v);
    const ext  = /\.(png|jpe?g|webp|gif|svg)(\?|$)/i.test(v);
    const supa = v.includes('/storage/v1/object/') || v.includes('/object/public/');
    return http && (ext || supa);
  };

  const esc = s => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

  const initials = (txt)=>{
    const s=(txt||'').trim(); if(!s) return '👤';
    const at = s.includes('@') ? s.split('@')[0] : s;
    const parts = at.split(/[.\s_-]+/).filter(Boolean);
    return (parts[0]?.[0]||'').toUpperCase() + (parts[1]?.[0]||'').toUpperCase();
  };

  // تنسيق القيم داخل السطر
  function fmt(val, key){
    if (val === null || val === undefined || val === '') return '<span class="old">—</span>';
    if (key === 'rank') return `<span class="old">${esc(rankLabel(val))}</span>`;
    if (isBool(val)) return `<span class="old">${val?'مفعّل':'غير مفعّل'}</span>`;
    if (looksLikeImage(val, key)) return `<img class="thumb" src="${esc(String(val))}" alt="img">`;
    return `<span class="old">${esc(String(val))}</span>`;
  }

  // عنصر سطر تغيير (مضغوط – مثل ديسكورد)
  function diffLine(d){
    const k = d.key || '';
    return `
      <div class="diffline">
        <span class="label">${esc(label(k))}</span>
        <span class="old">${fmt(d.before,k)}</span>
        <span class="arrow">→</span>
        <span class="new"><b>${fmt(d.after,k).replace('class="old"','')}</b></span>
      </div>`;
  }

  function card(row){
    const diffs = Array.isArray(row.diffs) ? row.diffs : (row.diffs || []);
    const count = diffs.length;
    const actor = row.actor_email || '—';
    const targetName = row.target_name || '—';
    const targetId   = row.staff_id ? `#${row.staff_id}` : '';

    return `
      <article class="card" data-op="${row.op}">
        <div class="head">
          <span class="op-chip ${row.op}">${row.op}</span>
          <span class="time">${toKSA(row.created_at)}</span>
          <span class="actor"><span class="avatar">${initials(actor)}</span>${esc(actor)}</span>
          ${count?`<span class="count">${count}</span>`:''}
        </div>

        <div class="target">
          <span class="badge">المستهدف</span>
          <b>${esc(targetName)}</b>
          
        </div>

        ${count?`<div class="diffs">${diffs.map(diffLine).join('')}</div>`:`<div class="msg">تمت ازالته</div>`}
      </article>`;
  }

  async function load(){
    wrap.innerHTML = `<div class="msg">... تحميل</div>`;

    let q = sb.from('staff_logs')
      .select('id, created_at, op, actor_email, staff_id, target_name, diffs')
      .order('created_at', { ascending:false })
      .limit(500);

    if(opFilter.value !== 'all') q = q.eq('op', opFilter.value);
    if(fromDate.value){ q = q.gte('created_at', new Date(fromDate.value).toISOString()); }
    if(toDate.value){ const t=new Date(toDate.value); t.setDate(t.getDate()+1); q = q.lt('created_at', t.toISOString()); }
    if(search.value.trim()){
      const s = search.value.trim();
      q = q.or(`target_name.ilike.%${s}%,actor_email.ilike.%${s}%,staff_id.ilike.%${s}%`);
    }

    const { data, error } = await q;
    if(error){ wrap.innerHTML = `<div class="msg">فشل جلب اللوقات: ${esc(error.message)}</div>`; return; }
    wrap.innerHTML = (data && data.length) ? data.map(card).join('') : `<div class="msg">لا توجد سجلات.</div>`;
  }

  refresh.addEventListener('click', load);
  [opFilter, fromDate, toDate].forEach(el=> el.addEventListener('change', load));
  search.addEventListener('input', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(load,220); });

  sb.channel('staff-logs-rt').on('postgres_changes',{event:'*',schema:'public',table:'staff_logs'},load).subscribe();

  await load();
</script>
</body>
</html>
