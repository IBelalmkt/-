<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#080712; --bg2:#0f0b1f;
  --panel:rgba(17,14,33,.72);
  --card:rgba(18,16,36,.55);
  --text:#F2EFFF; --muted:#bfbad8;
  --chip:#15132a; --chip-br:rgba(255,255,255,.12);
  --ok:#63e7c4; --info:#75c9ff; --warn:#ffd36e; --danger:#ff8fb7;
  --border:1px solid rgba(255,255,255,.10);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--text); font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1000px 600px at 12% -10%, rgba(154,134,255,.15), transparent),
    radial-gradient(900px 600px at 92% 120%, rgba(106,240,194,.10), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}

/* NAV */
nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(16,12,32,.9),rgba(16,12,32,.65));backdrop-filter:blur(14px);border-bottom:var(--border)}
.nav-in{width:min(1100px,92%);margin:auto;padding:10px 0;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand .logo{width:34px;height:34px;border-radius:10px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:center;background:rgba(18,16,36,.45);border:var(--border);border-radius:12px;padding:6px 8px}
.toolbar>*{background:#171230;border:var(--border);color:var(--text);border-radius:10px;padding:8px 10px;font-weight:700;font-size:12px}
.toolbar .refresh{background:linear-gradient(180deg,#2b1e69,#221a51);cursor:pointer;border-color:rgba(154,134,255,.4)}
.link{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:var(--border);background:#171230;color:#e9e9ff;text-decoration:none;font-weight:800;font-size:12px}
.container{width:min(1100px,92%);margin:18px auto 40px}

/* TIMELINE + CARD (Discord-like) */
.timeline{position:relative}
.card{
  position:relative; overflow:hidden; margin:10px 0; padding:12px 14px 10px;
  background:var(--card); border:var(--border); border-radius:14px;
  box-shadow:0 14px 28px rgba(0,0,0,.26);
}
.card::before{ /* Ø´Ø±ÙŠØ· Ø¬Ø§Ù†Ø¨ÙŠ ÙŠØºÙŠÙ‘Ø± Ù„ÙˆÙ†Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */
  content:""; position:absolute; inset:0 auto 0 0; width:4px; background:var(--info);
}
.card[data-op="insert"]::before{ background:var(--ok); }
.card[data-op="update"]::before{ background:var(--info); }
.card[data-op="delete"]::before{ background:var(--danger); }

/* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.op-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--chip-br);background:#151736;font-weight:900;font-size:12px}
.op-chip.insert{background:rgba(99,231,196,.14);border-color:rgba(99,231,196,.28);color:#dffdf6}
.op-chip.update{background:rgba(117,201,255,.14);border-color:rgba(117,201,255,.28);color:#e9f6ff}
.op-chip.delete{background:rgba(255,143,183,.14);border-color:rgba(255,143,183,.28);color:#ffe6ef}
.time{padding:3px 8px;border:1px solid var(--chip-br);background:#15122d;border-radius:8px;font-size:12px;color:#dfe7ff}
.actor{margin-inline-start:auto;display:flex;align-items:center;gap:8px;font-weight:800}
.avatar{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:#1b1533;border:1px solid var(--chip-br);color:#cfe2ff;font-size:11px}
.count{background:#15122a;border:var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:#cdd5ff}

/* Ù‡Ø¯Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù„Ø·ÙŠÙ) */
.target{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 6px}
.badge{background:var(--chip);border:1px solid var(--chip-br);padding:4px 10px;border-radius:999px;font-size:12px;color:#c9c6ee}
.target b{color:#fff}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª â€“ Ø´ÙƒÙ„ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ø«Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ */
.diffs{display:grid;gap:6px}
.diffline{
  display:flex;align-items:center;gap:10px;
  background:rgba(17,15,38,.45); border:1px solid var(--chip-br);
  border-radius:10px; padding:8px 10px; font-size:13px;
  /* Ù…Ù‡Ù…: Ù†Ø®Ù„ÙŠ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø·Ø± LTR Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ù‡Ù… ÙŠØ¸Ù„ ÙŠØ´ÙŠØ± Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  direction:ltr;
}
.diffline .label{direction:rtl; font-weight:800; color:#e9e6ff; background:var(--chip); border:1px solid var(--chip-br); padding:2px 8px; border-radius:999px}
.diffline .old{direction:rtl; opacity:.8}
.diffline .arrow{opacity:.75}
.diffline .new{direction:rtl; font-weight:800}
.thumb{width:38px;height:38px;border-radius:8px;object-fit:cover;border:1px solid var(--chip-br);vertical-align:middle}

/* Ø±Ø³Ø§Ø¦Ù„ ÙØ§Ø±ØºØ© / Ø®Ø·Ø£ */
.msg{padding:16px;text-align:center;color:var(--muted);border:1px dashed rgba(255,255,255,.25);border-radius:12px;background:rgba(18,16,36,.35)}

/* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:640px){
  .nav-in{grid-template-columns:1fr auto}
  .brand{grid-column:1/3}
  .toolbar{flex-wrap:wrap}
}
</style>
</head>
<body>

<nav>
  <div class="nav-in">
    <div class="brand"><span class="logo"></span><span>Ù„ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</span></div>

    <div class="toolbar">
      <button id="refresh" class="refresh">ØªØ­Ø¯ÙŠØ«</button>
      <select id="opFilter">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
        <option value="insert">insert</option>
        <option value="update">update</option>
        <option value="delete">delete</option>
      </select>
      <input id="from" type="date" title="Ù…Ù†" />
      <span>Ø¥Ù„Ù‰</span>
      <input id="to" type="date" title="Ø¥Ù„Ù‰" />
      <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" style="flex:1" />
    </div>

    <div class="nav-actions">
      <a class="link" href="admin.html">âŸµ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>
  </div>
</nav>

<main class="container">
  <section class="timeline">
    <div id="logsWrap"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const sb = createClient(
    "https://kdsnmgfrdykmupnrmksy.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkc25tZ2ZyZHlrbXVwbnJta3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE2NDgsImV4cCI6MjA3NDcyNzY0OH0.Ly_frv4P1P45OYmTEt6hDThSx5rD6S1a96dNKhVc1Yc"
  );

  const wrap     = document.getElementById("logsWrap");
  const refresh  = document.getElementById("refresh");
  const opFilter = document.getElementById("opFilter");
  const search   = document.getElementById("search");
  const fromDate = document.getElementById("from");
  const toDate   = document.getElementById("to");

  const toKSA = (ts)=>{
    try{
      return new Date(ts).toLocaleString('en-GB',{
        timeZone:'Asia/Riyadh',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }catch{ return ts; }
  };

  const rankLabel = r => ({A:'Ù…Ø³Ø¤ÙˆÙ„',V:'Ù†Ø§Ø¦Ø¨',AD:'Ø§Ø³ØªØ´Ø§Ø±ÙŠ',DS:'Ø£Ø®ØµØ§Ø¦ÙŠ',D:'Ø¯ÙƒØªÙˆØ±',DA:'Ù…Ø³Ø§Ø¹Ø¯ Ø¯ÙƒØªÙˆØ±',N:'Ù…Ù…Ø±Ø¶',T:'Ù…ØªØ¯Ø±Ø¨',C:'Ù…ØªØ·ÙˆØ¹'})[r]||r;
  const labelMap = {
    name:'Ø§Ù„Ø§Ø³Ù…', nid:'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ', rank:'Ø§Ù„Ø±ØªØ¨Ø©', rank_no:'Ø§Ù„ØªØ³Ù„Ø³Ù„',
    health_role:'Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØµØ­ÙŠ', specialty:'Ø§Ù„ØªØ®ØµØµ', warnings:'Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª',
    photo:'Ø§Ù„ØµÙˆØ±Ø©', notes:'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
    cert_heli:'Ø´Ù‡Ø§Ø¯Ø© Ù‡Ù„ÙŠÙƒÙˆØ¨ØªØ±', cert_ops:'Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù…Ù„ÙŠØ§Øª', cert_diving:'Ø´Ù‡Ø§Ø¯Ø© ØºÙˆØµ',
    cert_boat:'Ø´Ù‡Ø§Ø¯Ø© Ù‚ÙŠØ§Ø¯Ø© Ù‚Ø§Ø±Ø¨', cert_fitness:'ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ù„ÙŠØ§Ù‚Ø©', cert_med_report:'ØªÙ‚Ø§Ø±ÙŠØ± Ø·Ø¨ÙŠØ©',
    test_specialty:'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„ØªØ®ØµØµ', test_reports:'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ‚Ø§Ø±ÙŠØ±', test_mountain:'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¨Ø§Ù„'
  };
  const label = k => labelMap[k] || k;

  const isBool = v => v === true || v === false;

  // Ù†Ø¹Ø±Ù‘Ù "ØµÙˆØ±Ø©" Ø­ØªÙ‰ Ù„Ùˆ Ø±Ø§Ø¨Ø· Ø³ÙˆÙ¾Ø§Ø¨ÙŠØ² Ø¨Ù„Ø§ Ø§Ù…ØªØ¯Ø§Ø¯
  const looksLikeImage = (v, key) => {
    if (key === 'photo' && typeof v === 'string') return true;
    if (typeof v !== 'string') return false;
    const http = /^https?:\/\//i.test(v);
    const ext  = /\.(png|jpe?g|webp|gif|svg)(\?|$)/i.test(v);
    const supa = v.includes('/storage/v1/object/') || v.includes('/object/public/');
    return http && (ext || supa);
  };

  const esc = s => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

  const initials = (txt)=>{
    const s=(txt||'').trim(); if(!s) return 'ğŸ‘¤';
    const at = s.includes('@') ? s.split('@')[0] : s;
    const parts = at.split(/[.\s_-]+/).filter(Boolean);
    return (parts[0]?.[0]||'').toUpperCase() + (parts[1]?.[0]||'').toUpperCase();
  };

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø·Ø±
  function fmt(val, key){
    if (val === null || val === undefined || val === '') return '<span class="old">â€”</span>';
    if (key === 'rank') return `<span class="old">${esc(rankLabel(val))}</span>`;
    if (isBool(val)) return `<span class="old">${val?'Ù…ÙØ¹Ù‘Ù„':'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'}</span>`;
    if (looksLikeImage(val, key)) return `<img class="thumb" src="${esc(String(val))}" alt="img">`;
    return `<span class="old">${esc(String(val))}</span>`;
  }

  // Ø¹Ù†ØµØ± Ø³Ø·Ø± ØªØºÙŠÙŠØ± (Ù…Ø¶ØºÙˆØ· â€“ Ù…Ø«Ù„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯)
  function diffLine(d){
    const k = d.key || '';
    return `
      <div class="diffline">
        <span class="label">${esc(label(k))}</span>
        <span class="old">${fmt(d.before,k)}</span>
        <span class="arrow">â†’</span>
        <span class="new"><b>${fmt(d.after,k).replace('class="old"','')}</b></span>
      </div>`;
  }

  function card(row){
    const diffs = Array.isArray(row.diffs) ? row.diffs : (row.diffs || []);
    const count = diffs.length;
    const actor = row.actor_email || 'â€”';
    const targetName = row.target_name || 'â€”';
    const targetId   = row.staff_id ? `#${row.staff_id}` : '';

    return `
      <article class="card" data-op="${row.op}">
        <div class="head">
          <span class="op-chip ${row.op}">${row.op}</span>
          <span class="time">${toKSA(row.created_at)}</span>
          <span class="actor"><span class="avatar">${initials(actor)}</span>${esc(actor)}</span>
          ${count?`<span class="count">${count}</span>`:''}
        </div>

        <div class="target">
          <span class="badge">Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</span>
          <b>${esc(targetName)}</b>
          
        </div>

        ${count?`<div class="diffs">${diffs.map(diffLine).join('')}</div>`:`<div class="msg">ØªÙ…Øª Ø§Ø²Ø§Ù„ØªÙ‡</div>`}
      </article>`;
  }

  async function load(){
    wrap.innerHTML = `<div class="msg">... ØªØ­Ù…ÙŠÙ„</div>`;

    let q = sb.from('staff_logs')
      .select('id, created_at, op, actor_email, staff_id, target_name, diffs')
      .order('created_at', { ascending:false })
      .limit(500);

    if(opFilter.value !== 'all') q = q.eq('op', opFilter.value);
    if(fromDate.value){ q = q.gte('created_at', new Date(fromDate.value).toISOString()); }
    if(toDate.value){ const t=new Date(toDate.value); t.setDate(t.getDate()+1); q = q.lt('created_at', t.toISOString()); }
    if(search.value.trim()){
      const s = search.value.trim();
      q = q.or(`target_name.ilike.%${s}%,actor_email.ilike.%${s}%,staff_id.ilike.%${s}%`);
    }

    const { data, error } = await q;
    if(error){ wrap.innerHTML = `<div class="msg">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù„ÙˆÙ‚Ø§Øª: ${esc(error.message)}</div>`; return; }
    wrap.innerHTML = (data && data.length) ? data.map(card).join('') : `<div class="msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</div>`;
  }

  refresh.addEventListener('click', load);
  [opFilter, fromDate, toDate].forEach(el=> el.addEventListener('change', load));
  search.addEventListener('input', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(load,220); });

  sb.channel('staff-logs-rt').on('postgres_changes',{event:'*',schema:'public',table:'staff_logs'},load).subscribe();

  await load();
</script>
</body>
</html>
