<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مستشفى ريسبكت</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0712; --panel:#0f0b1a; --card:#131020; --muted:#a7a4be; --text:#efecff;
  --brand:#8b7bff; --accent:#ff6b9e; --ok:#54e6a6; --border:1px solid rgba(255,255,255,.08);
  --cyan:#7fd8ff;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 500px at 20% -10%, rgba(139,123,255,.11), transparent), var(--bg); color:var(--text); font-family:"Cairo",sans-serif}
.container{width:min(1200px,92%);margin:auto}

/* Intro */
#intro{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0613 0%,#120c1f 70%);}
.intro-box{display:grid;place-items:center;gap:8px;text-align:center;animation:fadeUp .7s ease both}
.intro-logo{width:110px;height:110px;border-radius:28px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 10px 40px rgba(139,123,255,.35);animation:pulse 1.8s ease-in-out infinite}
.intro-title{font-size:22px;font-weight:800}
.intro-sub{font-size:13px;color:#c8c3e7}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.hide-intro{animation:fadeOut .8s ease forwards}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

/* NAV */
nav{position:sticky;top:0;z-index:30;background:rgba(15,11,26,.7);backdrop-filter:blur(10px);border-bottom:var(--border)}
.nav-in{display:flex;align-items:center;gap:12px;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand .logo{width:34px;height:34px;border-radius:10px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 0 0 1px rgba(255,255,255,.09) inset}
.search{flex:1;display:flex;align-items:center;background:#17132c;border:var(--border);border-radius:12px;padding:8px 12px}
.search input{all:unset;flex:1;color:var(--text);}
.link-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171230;color:#e9e9ff;text-decoration:none;font-weight:700;font-size:12px}
.link-chip .ico{font-size:14px;opacity:.85}
.stat{display:inline-flex;align-items:center;gap:10px;cursor:pointer;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171230;color:#dfe3ff;font-weight:700;font-size:12px}
.stat .dot{width:8px;height:8px;border-radius:50%;background:#3be48f;box-shadow:0 0 0 3px rgba(59,228,143,.12)}
.stat small{opacity:.8;font-weight:600}

/* زر الفلترة بصورة */
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;border:var(--border);background:#171230;cursor:pointer}
.icon-btn img{width:22px;height:22px;filter:invert(1)}

/* فلتر */
.filter-wrap{position:relative}
.filter-panel{position:absolute;right:0;top:42px;width:260px;background:#0f0b1a;border:var(--border);border-radius:14px;padding:10px;display:none;z-index:40}
.filter-panel.open{display:block}
.filter-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
.filter-row label{font-size:13px;color:#d6dcf3}
.filter-row .count{font-size:12px;color:#9fb0c4;background:#15122a;border:1px solid rgba(255,255,255,.08);padding:2px 8px;border-radius:999px}
.filter-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* ORGANIZATION GRID */
.org{display:grid;gap:18px;margin:16px 0}
.row{display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
.row-A{justify-content:center;margin-top:6px}
.row-A .card{transform:translateY(-8px)}
.row-V{justify-content:center}

/* CARD */
.card{position:relative;background:rgba(25,18,38,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;width:260px;box-shadow:0 8px 28px rgba(139,92,246,.10)}
.card .media{display:grid;place-items:center;padding:14px 0 6px}
.card .avatar{width:88px;height:88px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.1);box-shadow:0 0 0 4px rgba(255,255,255,.05)}
.card .content{padding:10px 12px;display:grid;gap:6px}
.card .title{font-size:15px;font-weight:800}
.card .meta{font-size:12px;color:#aeb6c7;display:grid;gap:2px}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:11px;line-height:1;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#cfd6e6}
.pill.heli{border-color:#ff6b6b;color:#ff9aa2;background:rgba(255,107,107,.12)}
.rank-badge{position:absolute;inset:8px 8px auto auto;background:#281f4e;border:1px solid rgba(255,255,255,.12);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}
.health-badge{position:absolute;inset:8px auto auto 8px;background:rgba(127,216,255,.14); color:#bfeaff;border:1px solid rgba(127,216,255,.35);padding:4px 8px;border-radius:999px;font-size:12px}

/* إنذارات */
.warns{position:absolute;bottom:12px;left:12px;display:flex;gap:6px}
.warns .w{width:8px;height:8px;border-radius:50%;background:#3a3a50;border:1px solid rgba(255,255,255,.12)}
.warns .w.active{background:#ff9aa9}

/* Mobile */
@media (max-width: 520px){
  .card{width:220px}
  .warns .w{width:6px;height:6px}
  .rank-badge,.health-badge{font-size:11px;padding:3px 8px}
  .pill{font-size:10px;padding:5px 8px}
}
</style>
</head>
<body>

<div id="intro"><div class="intro-box">
  <div class="intro-logo"></div>
  <div class="intro-title">مستشفى ريسبكت</div>
  <div class="intro-sub">الطاقم الطبي</div>
</div></div>

<nav>
  <div class="container nav-in">
    <div class="brand"><span class="logo"></span><span>مستشفى ريسبكت</span></div>
    <div class="search"><input id="searchInput" placeholder="بحث بالاسم او الرقم الوطني"></div>

    <a class="link-chip" href="promotion.html"><span class="ico">⬈</span><span>متطلبات الترقية</span></a>

    <div class="stat" id="statTotal"><span class="dot"></span><span>الإجمالي</span><small>— 0</small></div>

    <div class="filter-wrap">
      <!-- زر بصورة setting.png -->
      <button id="openFilters" class="icon-btn" aria-label="فلترة">
        <img src="setting.png" alt="فلترة">
      </button>

      <div class="filter-panel" id="filterPanel">
        <!-- مبدئيًا غير محدد؛ العرض سيكون الكل إذا لم تُحدَّد أي رتبة -->
        <div class="filter-row"><label><input type="checkbox" data-r="A"> مسؤول</label><span class="count" id="cntA">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="V"> نائب</label><span class="count" id="cntV">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="AD"> استشاري</label><span class="count" id="cntAD">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="DS"> أخصائي</label><span class="count" id="cntDS">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="D"> دكتور</label><span class="count" id="cntD">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="DA"> مساعد دكتور</label><span class="count" id="cntDA">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="N"> ممرض</label><span class="count" id="cntN">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="T"> متدرب</label><span class="count" id="cntT">0</span></div>
        <div class="filter-row"><label><input type="checkbox" data-r="C"> متطوع</label><span class="count" id="cntC">0</span></div>

        <div class="filter-actions">
          <button id="applyFilters" class="link-chip" type="button"><span class="ico">✓</span>تطبيق</button>
          <button id="resetFilters" class="link-chip" type="button"><span class="ico">↺</span>مسح</button>
        </div>
      </div>
    </div>
  </div>
</nav>

<header class="container"></header>

<main class="container">
  <div id="org" class="org"></div>
</main>

<footer style="text-align:center;padding:18px 0;color:var(--muted);border-top:var(--border);background:#0f0b1a">
  © <span id="year"></span> مستشفى ريسبكت.
</footer>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL = "https://kdsnmgfrdykmupnrmksy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkc25tZ2ZyZHlrbXVwbnJta3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE2NDgsImV4cCI6MjA3NDcyNzY0OH0.Ly_frv4P1P45OYmTEt6hDThSx5rD6S1a96dNKhVc1Yc";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const org=document.getElementById('org'), statTotal=document.getElementById('statTotal'), searchInput=document.getElementById('searchInput');
document.getElementById('year').textContent=new Date().getFullYear();
setTimeout(()=>document.getElementById('intro')?.classList.add('hide-intro'),1200);

const rankOrder=['A','V','AD','DS','D','DA','N','T','C'];
const rankLabel=r=>({A:'مسؤول',V:'نائب',AD:'استشاري',DS:'أخصائي',D:'دكتور',DA:'مساعد دكتور',N:'ممرض',T:'متدرب',C:'متطوع'})[r]||r;

let ALL=[]; 
// مبدئيًا نعرض الكل (حتى لو الشيكبوكس غير محدد)
let STATE={ ranks:new Set(rankOrder), q:'' };

const openFilters = document.getElementById('openFilters');
const filterPanel = document.getElementById('filterPanel');
const applyFilters = document.getElementById('applyFilters');
const resetFilters = document.getElementById('resetFilters');

const pill=(t,cls='')=>`<span class="pill ${cls}">${t}</span>`;
const warnsHTML=n=> new Array(3).fill(0).map((_,i)=>`<span class="w ${n>i?'active':''}"></span>`).join('');
const certList=x=>{
  const a=[]; 
  if(x.cert_heli) a.push({t:'شهادة هيلكوبتر', cls:'heli'});
  if(x.cert_ops) a.push({t:'شهادة عمليات'});
  if(x.cert_diving) a.push({t:'شهادة غوص'});
  if(x.cert_boat) a.push({t:'شهادة قيادة قارب'});
  if(x.cert_med_report) a.push({t:'تقارير طبية'});
  if(x.cert_fitness) a.push({t:'تقرير فحص لياقة'});
  if(x.test_specialty) a.push({t:'اختبار بالتخصص'});
  if(x.test_reports) a.push({t:'اختبارات تقارير'});
  if(x.test_mountain) a.push({t:'اختبار الجبال'});
  if(x.test_simulation) a.push({t:'اختبار محاكاة'}); /* ← الإضافة الوحيدة */
  return a;
};

function cardHTML(x){
  const certs = certList(x).map(c=>pill(c.t, c.cls||'')).join('');
  const health = x.health_role ? `<div class="health-badge">${x.health_role}</div>` : '';
  return `
  <article class="card">
    <div class="rank-badge">${x.rank}-${x.rank_no}</div>
    ${health}
    <div class="media"><img class="avatar" src="${x.photo||''}" alt="${x.name||''}"></div>
    <div class="content">
      <div class="title">${x.name||'بدون اسم'}</div>
      <div class="meta">
        <div>الرقم الوطني: <b>${x.nid||'—'}</b></div>
        <div>الرتبة: <b>${rankLabel(x.rank)}</b></div>
        ${x.specialty ? `<div>التخصص: <b>${x.specialty}</b></div>`:''}
      </div>
      <div class="pills">${certs}</div>
    </div>
    <div class="warns">${warnsHTML(x.warnings||0)}</div>
  </article>`;
}

function countByRank(data){
  const out={}; for(const r of rankOrder) out[r]=0;
  data.forEach(x=>{ if(out[x.rank]!==undefined) out[x.rank]++; });
  return out;
}

function render(){
  const q=STATE.q.trim().toLowerCase();
  let list=ALL.filter(x=>{
    // لو ما في تحديد -> نعرض الكل
    const okRank = STATE.ranks.size ? STATE.ranks.has(x.rank) : true;
    const okQ=!q || x.name?.toLowerCase().includes(q) || x.nid?.includes(q);
    return okRank && okQ;
  });

  const groups={}; rankOrder.forEach(r=>groups[r]=[]);
  list.forEach(x=>groups[x.rank]?.push(x));
  rankOrder.forEach(r=>groups[r].sort((a,b)=>(a.rank_no||0)-(b.rank_no||0)));

  org.innerHTML = `
    <div class="row row-A">${groups.A.map(cardHTML).join('')}</div>
    <div class="row row-V">${groups.V.map(cardHTML).join('')}</div>
    ${['AD','DS','D','DA','N','T','C'].map(r=>`<div class="row row-${r}">${groups[r].map(cardHTML).join('')}</div>`).join('')}
  `;
  statTotal.querySelector('small').textContent=` ${list.length}`;

  const counts = countByRank(ALL);
  for(const r of rankOrder){
    const el = document.getElementById('cnt'+r) || document.getElementById('cnt'+(r==='AD'?'AD':r));
    if(el) el.textContent = counts[r]||0;
  }
}

async function load(){
  const {data,error}=await sb.from('staff').select('*');
  ALL=error?[]:data||[];
  render();
}
statTotal.onclick=load;

/* Filters + search */
document.getElementById('searchInput').oninput=()=>{STATE.q=searchInput.value;render();};

/* فتح/إغلاق اللوحة */
openFilters.onclick=(e)=>{ e.stopPropagation(); filterPanel.classList.toggle('open'); };

/* تطبيق: ما نقفل اللوحة */
applyFilters.onclick=()=>{
  const checks = filterPanel.querySelectorAll('input[type="checkbox"][data-r]');
  const selected = Array.from(checks).filter(c=>c.checked).map(c=>c.getAttribute('data-r'));
  STATE.ranks = new Set(selected.length ? selected : []); // فاضي => عرض الكل
  render();
};

/* مسح: إلغاء كل التحديد وإبقاء العرض (كل) */
resetFilters.onclick=()=>{
  const checks = filterPanel.querySelectorAll('input[type="checkbox"][data-r]');
  checks.forEach(c=>c.checked=false);
  STATE.ranks = new Set(); // فارغ => عرض الكل
  render();
};

/* إغلاق عند الضغط خارج البطاقة */
document.addEventListener('click', (e)=>{
  const withinPanel = filterPanel.contains(e.target);
  const onButton = openFilters.contains(e.target);
  if(filterPanel.classList.contains('open') && !withinPanel && !onButton){
    filterPanel.classList.remove('open');
  }
});

sb.channel('staff-rt').on('postgres_changes',{event:'*',schema:'public',table:'staff'},p=>{
  const {eventType,new:NEW,old:OLD}=p;
  if(eventType==='INSERT'){ALL.push(NEW);}
  else if(eventType==='UPDATE'){const i=ALL.findIndex(r=>r.id===NEW.id); if(i>-1) ALL[i]=NEW; else ALL.push(NEW);}
  else if(eventType==='DELETE'){ALL=ALL.filter(r=>r.id!==OLD.id);}
  render();
}).subscribe();

await load();
</script>
</body>
</html>
