<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>فريق ريسبكت — الطاقم</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0712; --panel:#0f0b1a; --card:#131020; --muted:#a7a4be; --text:#efecff;
  --brand:#8b7bff; --accent:#ff6b9e; --ok:#54e6a6; --border:1px solid rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 500px at 20% -10%, rgba(139,123,255,.11), transparent), var(--bg); color:var(--text); font-family:"Cairo",sans-serif}
.container{width:min(1200px,92%);margin:auto}

/* Intro */
#intro{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b0613 0%,#120c1f 70%);}
.intro-box{display:grid;place-items:center;gap:8px;text-align:center;animation:fadeUp .7s ease both}
.intro-logo{width:110px;height:110px;border-radius:28px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 10px 40px rgba(139,123,255,.35);animation:pulse 1.8s ease-in-out infinite}
.intro-title{font-size:22px;font-weight:800}
.intro-sub{font-size:13px;color:#c8c3e7}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.hide-intro{animation:fadeOut .8s ease forwards}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

/* NAV */
nav{position:sticky;top:0;z-index:20;background:rgba(15,11,26,.7);backdrop-filter:blur(10px);border-bottom:var(--border)}
.nav-in{display:flex;align-items:center;gap:12px;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand .logo{width:34px;height:34px;border-radius:10px;background:url('RTHospital.png') center/cover no-repeat;box-shadow:0 0 0 1px rgba(255,255,255,.09) inset}
.search{flex:1;display:flex;align-items:center;background:#17132c;border:var(--border);border-radius:12px;padding:8px 12px}
.search input{all:unset;flex:1;color:var(--text);}
.stat{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#171230;color:#dfe3ff;font-weight:700;font-size:12px}
.stat .dot{width:8px;height:8px;border-radius:50%;background:#3be48f;box-shadow:0 0 0 3px rgba(59,228,143,.12)}
.stat small{opacity:.8;font-weight:600}

/* Filters */
.filters{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.filters .chip{padding:6px 10px;font-size:12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#141122;color:#bfc7dc}
.filters .chip[aria-pressed="true"]{background:#f5f7ff;color:#120d1f;border-color:transparent}

/* ORG */
.org{display:grid;gap:18px;margin:16px 0}
.row{display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
.row-A{justify-content:center;margin-top:6px}
.row-A .card{transform:translateY(-8px)}
.row-V{justify-content:center}

/* CARD */
.card{position:relative;background:rgba(25,18,38,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;width:260px;box-shadow:0 8px 28px rgba(139,92,246,.10)}
.card .media{display:grid;place-items:center;padding-top:10px}
.card .avatar{width:88px;height:88px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.1);box-shadow:0 0 0 4px rgba(255,255,255,.05)}
.card .content{padding:10px 12px;display:grid;gap:6px}
.card .title{font-size:15px;font-weight:800}
.card .meta{font-size:12px;color:#aeb6c7;display:grid;gap:2px}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{display:inline-flex;align-items:center;gap:6px;font-size:11px;line-height:1;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#cfd6e6}
/* ✅ تمييز شهادة الهيلكوبتر */
.pill.heli{ border-color:#ff4d6d; color:#ff4d6d; background:rgba(255,77,109,.08); }

.rank-badge{position:absolute;inset:8px 8px auto auto;background:#281f4e;border:1px solid rgba(255,255,255,.12);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}
/* إنذارات – أسفل يسار */
.warns{position:absolute;bottom:12px;left:12px;display:flex;gap:6px}
.warns .w{width:8px;height:8px;border-radius:50%;background:#3a3a50;border:1px solid rgba(255,255,255,.12)}
.warns .w.active{background:#ff9aa9}
</style>
</head>
<body>

<div id="intro"><div class="intro-box">
  <div class="intro-logo"></div>
  <div class="intro-title">فريق ريسبكت</div>
  <div class="intro-sub">الطاقم — عرض عام</div>
</div></div>

<nav>
  <div class="container nav-in">
    <div class="brand"><span class="logo"></span><span>إدارة الطاقم</span></div>
    <div class="search"><input id="searchInput" placeholder="بحث بالاسم أو الرقم الوطني"></div>
    <div class="stat" id="statTotal"><span class="dot"></span><span>الإجمالي</span><small>— 0</small></div>
    <a class="btn promote" href="./promotion.html" title="متطلبات الترقية">
  <!-- أيقونة شارة (SVG خفيف) -->
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M12 2a6 6 0 0 0-3 11.2V22l3-2 3 2v-8.8A6 6 0 0 0 12 2zm0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"/>
  </svg>
  <span>متطلبات الترقية</span>
</a>


  </div>
</nav>

<header class="container">
  <div class="filters">
    <button class="chip" data-rank="all" aria-pressed="true">الكل</button>
    <button class="chip" data-rank="A">مسؤول</button>
    <button class="chip" data-rank="V">نائب</button>
    <button class="chip" data-rank="AD">استشاري</button>
    <button class="chip" data-rank="DS">أخصائي</button>
    <button class="chip" data-rank="D">دكتور</button>
    <button class="chip" data-rank="DA">مساعد دكتور</button>
    <button class="chip" data-rank="N">ممرض</button>
    <button class="chip" data-rank="T">متدرب</button>
    <button class="chip" data-rank="C">متطوع</button>
  </div>
</header>

<main class="container">
  <div id="org" class="org"></div>
</main>

<footer style="text-align:center;padding:18px 0;color:var(--muted);border-top:var(--border);background:#0f0b1a">
  © <span id="year"></span> فريق ريسبكت
</footer>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL = "https://kdsnmgfrdykmupnrmksy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkc25tZ2ZyZHlrbXVwbnJta3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTE2NDgsImV4cCI6MjA3NDcyNzY0OH0.Ly_frv4P1P45OYmTEt6hDThSx5rD6S1a96dNKhVc1Yc";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const org=document.getElementById('org'), statTotal=document.getElementById('statTotal'), searchInput=document.getElementById('searchInput');
document.getElementById('year').textContent=new Date().getFullYear();
setTimeout(()=>document.getElementById('intro')?.classList.add('hide-intro'),1200);

const rankOrder=['A','V','AD','DS','D','DA','N','T','C'];
const rankLabel=r=>({A:'مسؤول',V:'نائب',AD:'استشاري',DS:'أخصائي',D:'دكتور',DA:'مساعد دكتور',N:'ممرض',T:'متدرب',C:'متطوع'})[r]||r;

let ALL=[]; let STATE={rank:'all',q:''};

const pill=t=>`<span class="pill">${t}</span>`;
const warnsHTML=n=> new Array(3).fill(0).map((_,i)=>`<span class="w ${n>i?'active':''}"></span>`).join('');
const certList=x=>{
  const a=[]; if(x.cert_heli) a.push('شهادة هيلكوبتر'); if(x.cert_ops) a.push('شهادة عمليات');
  if(x.cert_diving) a.push('شهادة غوص'); if(x.cert_boat) a.push('شهادة قيادة قارب');
  if(x.cert_med_report) a.push('شهادة تقارير طبية'); if(x.cert_fitness) a.push('شهادة تقرير فحص لياقة');
  if(x.test_specialty) a.push('اختبار بالتخصص'); if(x.test_reports) a.push('اختبارات تقارير بالتخصص');
  return a;
};
function cardHTML(x){
  // ✅ أضف كلاس heli إذا كانت هيلكوبتر
  const certHTML = certList(x).map(t=>`<span class="pill ${t==='شهادة هيلكوبتر'?'heli':''}">${t}</span>`).join('');
  return `
  <article class="card">
    <div class="rank-badge">${x.rank}-${x.rank_no}</div>
    <div class="media"><img class="avatar" src="${x.photo||''}" alt="${x.name||''}"></div>
    <div class="content">
      <div class="title">${x.name||'بدون اسم'}</div>
      <div class="meta">
        <div>الرقم الوطني: <b>${x.nid||'—'}</b></div>
        <div>الرتبة: <b>${rankLabel(x.rank)}</b></div>
      </div>
      <div class="pills">${certHTML}</div>
    </div>
    <div class="warns">${warnsHTML(x.warnings||0)}</div>
  </article>`;
}

function render(){
  const q=STATE.q.trim().toLowerCase();
  let list=ALL.filter(x=>{
    const okRank=(STATE.rank==='all')?true:x.rank===STATE.rank;
    const okQ=!q || x.name?.toLowerCase().includes(q) || x.nid?.includes(q);
    return okRank && okQ;
  });

  const groups={}; rankOrder.forEach(r=>groups[r]=[]);
  list.forEach(x=>groups[x.rank]?.push(x));
  rankOrder.forEach(r=>groups[r].sort((a,b)=>(a.rank_no||0)-(b.rank_no||0)));

  org.innerHTML = `
    <div class="row row-A">${groups.A.map(cardHTML).join('')}</div>
    <div class="row row-V">${groups.V.map(cardHTML).join('')}</div>
    ${['AD','DS','D','DA','N','T','C'].map(r=>`<div class="row row-${r}">${groups[r].map(cardHTML).join('')}</div>`).join('')}
  `;
  statTotal.querySelector('small').textContent=`— ${ALL.length}`;
}

async function load(){
  const {data,error}=await sb.from('staff').select('*');
  ALL=error?[]:data||[];
  render();
}
statTotal.onclick=load;

document.querySelectorAll('.chip').forEach(c=>{
  c.onclick=()=>{document.querySelectorAll('.chip').forEach(b=>b.setAttribute('aria-pressed','false'));c.setAttribute('aria-pressed','true');STATE.rank=c.dataset.rank;render();}
});
searchInput.oninput=()=>{STATE.q=searchInput.value;render();};

sb.channel('staff-rt').on('postgres_changes',{event:'*',schema:'public',table:'staff'},p=>{
  const {eventType,new:NEW,old:OLD}=p;
  if(eventType==='INSERT'){ALL.push(NEW);}
  else if(eventType==='UPDATE'){const i=ALL.findIndex(r=>r.id===NEW.id); if(i>-1) ALL[i]=NEW; else ALL.push(NEW);}
  else if(eventType==='DELETE'){ALL=ALL.filter(r=>r.id!==OLD.id);}
  render();
}).subscribe();

await load();
</script>
</body>
</html>
